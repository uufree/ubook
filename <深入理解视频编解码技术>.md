# 深入理解视频编解码技术

[TOC]

## 视频编解码基础

### 编码方式

#### 预测编码（无损）

- 空间冗余：帧内预测编码

  详见H.264帧内预测技术

- 时间冗余：帧间预测编码

  - 运动补偿：根据运动矢量和帧间预测的方法，求得当前帧的估计值的过程。
  - 运动估计：寻找当前块在已编码图像中的最佳对应块，并且计算出相对最佳对应块的偏移量。
    - 光流方程法
    - 贝叶斯法
    - 像素递归法
    - **块匹配法**：基于块匹配的运动估计算法只考虑了块的简单平移，这样对于每一个分块，只需要一个运动矢量就能完全描述其运动状态。
      - 参考帧位置：前向预测，后向预测（编码延时），双向预测（编码延时）
      - 块大小：**16 × 16（宏块）**，8 × 8，4 × 4
      - 运动估计准则：SAD（绝对误差和），SATD，SSD（差值平方和），MAD（平均绝对差值），MSD（平均平方误差）
      - 运动搜索算法：三步法，二维对数法，交叉法，菱形法
      - 亚像素预测：物体的运动不可能总是以整像素为单位进行的，为了**提高搜索精度**，在运动估计中可以使用**1/2、1/4、1/8**的步长进行搜索。采用越小的步长进行运动搜索，得到的结果越准确，残差越小，压缩效果越好。
      - **重叠块补偿（OBMC）**：
        - 目的：**OBMC的引入主要是为了提高预测精度和降低编码的块效应**。
        - 原因：块效应主要是由于相邻块的编码损伤程度不同，从而产生灰度的跳跃性变化。
        - 方法：除了使用**块效应滤波器**，只能在预测是使用OMBC减小预测残差。对于当前的编码块，可以拥有多个备选的运动矢量，包括自身的运动矢量及周围已编码块的运动矢量，再引入一组**加权系数**，**对候选运行矢量进行加权**，得到最终的运行矢量。

#### 变化编码（无损）

- K-L变换：K-L变换是一个在统计意义下具有最小均方意义的变换，它具有最有的去相关性。
- 离散傅里叶变换（DFT）：离散傅里叶变换可以对图像进行频谱分析，进行滤波和降噪等处理，常用语语音信号处理。
- **离散余弦变换（DCT）**：
  - **DC系数（直流分量）**：在一个8×8变换系数矩阵中，（0,0）位置的元素就是直流分量
  - **AC系数（交流分量）**：在一个8×8变换系数矩阵中，除了（0,0）位置以外的元素就是直流分量
- **整数DCT变换**：DCT经常会将整数变成浮点数，无法用于无损压缩。整数余弦变换克服了这个缺点，总是将整数变换为整数，可用于无损压缩。
- 哈达玛变换：离散正交变换

#### 量化编码（有损）

- 标量量化：最基本的有损压缩编码工具，通过将信源信号映射成码表中的码字来达到压缩的目的。
  - 均匀量化：
    - 过程：将量化输入值的振幅进行**等值均分**。
    - 优点：计算处理简单
    - 缺点：量化误差大。
  - 非均匀量化：
    - 过程：将量化输入的振幅按照变化曲线的曲率大小进行**不等值划分**。
    - 优点：量化误差小
    - 缺点：计算处理复杂，需要较多的比特数。
  - 自适应量化：
    - 过程：按照输入数据的变化曲线的局部区域的特点，**自适应的修改和调整量化器参数**。
    - 优点：量化误差小
    - 缺点：算法设计复杂，实现成本高
- 矢量量化：**一次量化多个样本点的量化方法**，即将输入的数据几个一组分成许多组，成组的进行量化编码。使用矢量量化，是因为在图像和视频中同一个块的数据通常是相关的，一些模式的出现概率大于其他模式。矢量量化时，需要从码表中选出距离最近的一个码字表示一个多维样本或者采样序列。**矢量量化与标量量化相比具有更强的数据压缩能力**。

#### 熵编码（无损）

- Huffman编码：
  - 定义：**统计编码、变长编码**，对于出现频率高的信息，编码长度较短；对于出现频率低的信息，编码长度长。
  - 过程：
    1. 概率统计，得到n个不同概率的信息符号
    2. 将信源中的符号按照出现概率递减的顺序排列
    3. 在信源符号中，选择概率最小的两个，将他们的概率想加，计算结果作为其合事件的出现概率。在合并运算时，概率大的符号用编码0表示，概率小的符号用编码1表示
    4. 这时概率数为n-1个，将这n-1个概率按照从大到小的顺序重新排列
    5. 重复步骤3，将新排序后的最小两个概率想加，计算合事件概率。如此重复n-1次，直到相加的结果等于1为止
    6. 记录下概率为1处到当前信号源符号之间的0、1序列，从而得到每个符号的编码，构成Huffman码表
- 算术编码：
  - 定义：利用信源统计特征对信息进行无损压缩的一种熵编码方式
  - 过程：
    - **概率模型建立过程**：统计信源发出每个符号的概率大小，建立起相应的概率表，并确定区间的划分比例
    - **扫描编码过程**：根据信源输出的消息序列，不断分割并选择区间。消息序列中每个元素都要用来缩短这个区间。随着消息序列中元素的增长，所得到的区间也在变小，最终得到整个符号序列所对应的区间；再在该区间内选择一个代表性的小数，转化为二进制编码作为实际的编码输出。区间越短，需要表示这个区间的数位就越长
  - 缺点：
    - 有限精度
    - 进位反转
    - 概率建模
- WNC算术编码：解决算术编码的3个缺点
- 指数哥伦布编码
  - 定义：**可变长编码方法、多分辨率的编码方法**，它是使用一定规则构造码字的变长编码模式，常用于音视频编码标准中
  - 过程：将所有数字分为等大小不同的组，符号值较小的组分配的码长较短，同一组内符号码长基本相等，并且组的大小呈指数增长。

### 视频编码框架

- 视频数据组织结构

![视频数据组织结构](/home/sensetime/Documents/ubook/2-1.png)



### 视频质量评价

## H.264/AVC视频编解码技术

